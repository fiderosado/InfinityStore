{"version":3,"file":"index.js","sources":["../src/InfinityStore.js"],"sourcesContent":["import { useEffect , useState , useRef , useCallback } from \"react\";\r\n\r\n/***\r\n * InfinityStore is a powerful hook that allows you to manage multiple states in a single React hook for managing a state storage without limits\r\n * @param name\r\n * @param initialStore\r\n * @param callback\r\n * @returns {{state: null, store: ((function(*): (unknown))|*)}|(function(): *)|((function(): {handler: string}) & {get: (function(): boolean), put: put})}\r\n * @constructor\r\n */\r\nconst InfinityStore = (\r\n  name ,\r\n  initialStore ,\r\n  callback = () => ({})\r\n) => {\r\n  /**\r\n   * Retrieves the stored state from localStorage using the provided name.\r\n   * If no stored state is found, returns an empty object.\r\n   *\r\n   * @type {Object}\r\n   */\r\n  const storedState = JSON.parse(localStorage.getItem(name) || \"{}\");\r\n  /**\r\n   * React state hook that combines the initial state with the stored state.\r\n   *\r\n   * @type {[Object, function]}\r\n   */\r\n  const [states , setStates] = useState({ ...initialStore , ...storedState });\r\n  /**\r\n   * React ref to store the current state.\r\n   *\r\n   * @type {Object}\r\n   */\r\n  const stateRef = useRef(states);\r\n  /**\r\n   * React ref for the BroadcastChannel.\r\n   *\r\n   * @type {Object}\r\n   */\r\n  const channelRef = useRef(null);\r\n  /**\r\n   * React ref for the state proxy.\r\n   *\r\n   * @type {Object}\r\n   */\r\n  const stateProxy = useRef(null);\r\n  /***\r\n   * stateManager is a function that allows you to manage the state\r\n   * @type {function(*): {set: function(*, *): void, get: function(): *, value: *}}\r\n   */\r\n  const stateManager = useCallback(\r\n    (key) => {\r\n      /***\r\n       * set is a function that allows you to update the state\r\n       * @param valueOrUpdater\r\n       * @param callback\r\n       */\r\n      const set = (valueOrUpdater , callback) => {\r\n        setStates((prev) => {\r\n          const currentValue = prev[key];\r\n          let newValue;\r\n          if ( typeof valueOrUpdater === \"function\" ){\r\n            newValue = valueOrUpdater(currentValue);\r\n          } else if (\r\n            typeof currentValue === \"object\" &&\r\n            currentValue !== null &&\r\n            typeof valueOrUpdater === \"object\" &&\r\n            valueOrUpdater !== null &&\r\n            !Array.isArray(valueOrUpdater)\r\n          ){\r\n            newValue = { ...currentValue , ...valueOrUpdater };\r\n          } else {\r\n            newValue = valueOrUpdater;\r\n          }\r\n          const updatedState = { ...prev , [key]: newValue };\r\n          if ( callback ) callback(updatedState[key]);\r\n          channelRef.current?.postMessage({ type: \"stateChange\" , state: updatedState });\r\n          return updatedState;\r\n        });\r\n      };\r\n      return {\r\n        value: states[key] ,\r\n        set ,\r\n        get: () => states[key]\r\n      };\r\n    } ,\r\n    [states]\r\n  );\r\n\r\n  if ( !stateProxy.current ){\r\n    /***\r\n     * stateProxy is a function that allows you to manage the state\r\n     * @type {{}}\r\n     */\r\n    stateProxy.current = new Proxy(\r\n      {} ,\r\n      {\r\n        get(_ , prop){\r\n          if ( prop in states ){\r\n            const { value , get , set } = stateManager(prop);\r\n            const getterFunction = () => value;\r\n            getterFunction.set = set;\r\n            getterFunction.get = get;\r\n            return Object.assign(getterFunction , callback(stateProxy.current));\r\n          }\r\n          return Object.assign(() => ({ handler: \"target\" }) , {\r\n            get: () => false ,\r\n            put: () => {\r\n            }\r\n          });\r\n        }\r\n      }\r\n    );\r\n  }\r\n\r\n  /***\r\n   * storeResponse is a function that allows you to get the current\r\n   * @type {(function(*): (unknown))|*}\r\n   */\r\n  const storeResponse = useCallback(\r\n    (keys) => {\r\n      /***\r\n       * keys is a function that allows you to get the current state\r\n       */\r\n      if ( !keys ){\r\n        return { ...states };\r\n      }\r\n      /***\r\n       * keys is a function that allows you to get the current state\r\n       */\r\n      if ( !Array.isArray(keys) ){\r\n        throw new Error(\"La entrada a getAll debe ser un array de claves.\");\r\n      }\r\n      /***\r\n       * result is a function that allows you to get the current state\r\n       */\r\n      return keys.reduce(\r\n        (result , key) => {\r\n          if ( key in states ){\r\n            result[key] = states[key];\r\n          } else {\r\n            throw new Error(`El estado con clave \"${ key }\" no existe.`);\r\n          }\r\n          return result;\r\n        } ,\r\n        {}\r\n      );\r\n    } ,\r\n    [states]\r\n  );\r\n\r\n  /**\r\n   * useEffect hook to handle storage changes and channel messages.\r\n   * It updates the state when the localStorage or BroadcastChannel changes.\r\n   *\r\n   * @param {string} name - The name used as the key in localStorage and BroadcastChannel.\r\n   * @param {function} setStates - Function to update the state.\r\n   */\r\n  useEffect(() => {\r\n    /**\r\n     * Handles changes in localStorage and updates the state.\r\n     *\r\n     * @param {StorageEvent} event - The storage event that triggers the state update.\r\n     */\r\n    const handleStorageChange = (event) => {\r\n      if ( event.key === name && event.newValue ){\r\n        const newState = JSON.parse(event.newValue);\r\n        setStates(newState);\r\n      }\r\n    };\r\n    /**\r\n     * Handles messages from the BroadcastChannel and updates the state.\r\n     *\r\n     * @param {MessageEvent} event - The message event that triggers the state update.\r\n     */\r\n    const handleChannelMessage = (event) => {\r\n      if ( event.data.type === \"stateChange\" ){\r\n        setStates(event.data.state);\r\n      }\r\n    };\r\n    window.addEventListener(\"storage\" , handleStorageChange);\r\n    channelRef.current = new BroadcastChannel(name);\r\n    channelRef.current.addEventListener(\"message\" , handleChannelMessage);\r\n    return () => {\r\n      window.removeEventListener(\"storage\" , handleStorageChange);\r\n      channelRef.current?.close();\r\n    };\r\n  } , [name]);\r\n\r\n  useEffect(() => {\r\n    stateRef.current = states;\r\n    localStorage.setItem(name , JSON.stringify(states));\r\n  } , [name , states]);\r\n\r\n  useEffect(() => {\r\n    const syncState = (event) => {\r\n      if ( event.key === name ){\r\n        const newState = JSON.parse(event.newValue);\r\n        setStates(newState);\r\n      }\r\n    };\r\n  } , []);\r\n\r\n  return {\r\n    state: stateProxy.current ,\r\n    store: storeResponse\r\n  };\r\n};\r\n\r\nexport default InfinityStore;\r\n"],"names":["InfinityStore","name","initialStore","callback","arguments","length","undefined","storedState","JSON","parse","localStorage","getItem","_useState","useState","_objectSpread","_useState2","_slicedToArray","states","setStates","stateRef","useRef","channelRef","stateProxy","stateManager","useCallback","key","set","valueOrUpdater","prev","_channelRef$current","currentValue","newValue","_typeof","Array","isArray","updatedState","_defineProperty","current","postMessage","type","state","value","get","Proxy","_","prop","_stateManager","getterFunction","Object","assign","handler","put","storeResponse","keys","Error","reduce","result","concat","useEffect","handleStorageChange","event","newState","handleChannelMessage","data","window","addEventListener","BroadcastChannel","_channelRef$current2","removeEventListener","close","setItem","stringify","store"],"mappings":"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"}